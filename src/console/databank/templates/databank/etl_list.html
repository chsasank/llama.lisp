{% extends "databank/base.html" %}

{% block content %}
<div class="space-y-4">
    <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold text-consoleAccent">
            $ List ETL-configs
        </h2>
        <div class="flex gap-2">
            <a href="{% url 'etl_create' %}"
               class="px-3 py-1.5 text-sm border border-consoleAccent text-consoleAccent rounded hover:bg-consoleAccent hover:text-black transition">
                + Add ETL config
            </a>
            <a href="{% url 'run_all_etls' %}"
               class="px-3 py-1.5 text-sm border border-consoleBorder rounded hover:border-consoleAccent hover:text-consoleAccent transition">
                Run all ETL's
            </a>
        </div>
    </div>

    <section class="border border-consoleBorder rounded-lg bg-black/40 p-4">
        {% if etls %}
            <div class="space-y-3">
                {% for e in etls %}
                    <div class="border border-consoleBorder rounded-md px-3 py-2 flex flex-col md:flex-row md:items-center md:justify-between gap-2 hover:border-consoleAccent/70">
                        <div>
                            <div class="text-sm text-slate-100">
                                <span class="text-consoleAccent">{{ e.source_table }}</span>
                                <span class="text-slate-500"> â†’ </span>
                                <span class="text-slate-200">{{ e.target_table }}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-1">
                                src: {{ e.source_database.database_type }} (#{{ e.source_database.id }}) &nbsp;|
                                tgt: {{ e.target_database.database_type }} (#{{ e.target_database.id }})
                            </div>
                        </div>
                        <div class="flex gap-2 text-xs">
                            <a href="{% url 'etl_edit' e.id %}"
                               class="px-2 py-1 border border-consoleBorder rounded hover:border-consoleAccent hover:text-consoleAccent">
                                Edit
                            </a>
                            <a onclick="openDeleteModel('{{ e.id }}', 'ETL config')"
                            class="text-xs mx-2 px-2 py-1 border border-red-500 text-red-400 rounded hover:bg-red-500 hover:text-black transition cursor-pointer">
                                Delete
                            </a>
                            <a href="{% url 'run_single_etl' e.id %}"
                               class="px-2 py-1 border border-consoleAccent text-consoleAccent rounded hover:bg-consoleAccent hover:text-black">
                                Run
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-sm text-slate-500">
                No ETL configurations defined yet.
            </p>
        {% endif %}
    </section>
</div>

<!-- Delete Confirmation Model this model is reused for every ETL delete action-->
<div id="deleteModel"
     class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">

    <div class="bg-consolePanel border border-consoleBorder rounded-lg p-6 w-80 shadow-xl">
        <h3 class="text-lg font-semibold text-red-400 mb-3">$ Confirm Delete</h3>

        <p id="deleteMessage" class="text-slate-300 text-sm mb-5">
            Are you sure you want to delete this ETL config?
        </p>

        <div class="flex justify-end space-x-3">
            <button onclick="closeDeleteModel()"
               class="px-3 py-1 border border-consoleBorder rounded 
                      hover:border-consoleAccent hover:text-consoleAccent transition">
                Cancel
            </button>

            <a id="deleteConfirmBtn"
               href="#"
               class="px-3 py-1 border border-red-500 text-red-400 rounded hover:bg-red-500 hover:text-black transition">
                Delete
            </a>
        </div>
    </div>
</div>

<!-- JS to handle the delete model -->
<script>
    function openDeleteModel(id, label) {
        const modal = document.getElementById("deleteModel");
        const btn = document.getElementById("deleteConfirmBtn");
        const msg = document.getElementById("deleteMessage");

        msg.textContent = `Are you sure you want to delete this ${label}?`;

        // Set the delete URL for the selected ETL config
        btn.href = `/etls/${id}/delete/`;

        modal.classList.remove("hidden");
    }

    // closes the model
    function closeDeleteModel() {
        document.getElementById("deleteModel").classList.add("hidden");
    }
</script>
{% endblock %}
